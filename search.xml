<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>用Python爬取厚生劳动省派遣公司数据</title>
      <link href="2021/07/02/yong-python-pa-qu-hou-sheng-lao-dong-sheng-pai-qian-gong-si-shu-ju/"/>
      <url>2021/07/02/yong-python-pa-qu-hou-sheng-lao-dong-sheng-pai-qian-gong-si-shu-ju/</url>
      
        <content type="html"><![CDATA[<h1 id="用Python爬取厚生劳动省派遣公司数据"><a href="#用Python爬取厚生劳动省派遣公司数据" class="headerlink" title="用Python爬取厚生劳动省派遣公司数据"></a>用Python爬取厚生劳动省派遣公司数据</h1><h2 id="一、爬虫前的准备"><a href="#一、爬虫前的准备" class="headerlink" title="一、爬虫前的准备"></a>一、爬虫前的准备</h2><p>需要的技术知识</p><ul><li>js、html</li><li>Python</li><li>抓包</li><li>BeautifulSoup</li></ul><p>厚生劳动省的查询网站：<a href="https://jinzai.hellowork.mhlw.go.jp/JinzaiWeb/GICB102010.do">https://jinzai.hellowork.mhlw.go.jp/JinzaiWeb/GICB102010.do</a></p><h2 id="二、分析数据传输"><a href="#二、分析数据传输" class="headerlink" title="二、分析数据传输"></a>二、分析数据传输</h2><p>我们可以看到网站中有一系列筛选条件，我主要关注的是东京地区的公司，所以这里只对东京进行分析，其他的条件自行修改参数即可。我们按F12浏览器开发者模式，进入Network标签页，在页面上选择东京，点击检索。</p><p><img src="https://i.loli.net/2021/07/02/nihXtIgFCA6zVkG.png" alt="检索"></p><p>我们可以观察到Network的变化，其中GICB102010.do就是我们需要的</p><p><img src="https://i.loli.net/2021/07/02/H3ArwghYXf7VmCj.png" alt="抓包"></p><p>点击查看详情，在Headers部分可以看到它的一些基本信息，包括响应头、请求头和请求体等。</p><p><img src="https://i.loli.net/2021/07/02/O4rg5oPtdbHSJTC.png" alt="网络传输数据"></p><p><img src="https://i.loli.net/2021/07/02/9WSYwoGfvcAlmgB.png" alt="请求体参数数据"><br>这里的action参数，我们检索的时候为“search”，分页的时候为“page”。</p><p>接下来我们将用到图片中的数据进行网页信息的获取</p><h2 id="三、利用PostJson测试能否获取网页信息"><a href="#三、利用PostJson测试能否获取网页信息" class="headerlink" title="三、利用PostJson测试能否获取网页信息"></a>三、利用PostJson测试能否获取网页信息</h2><p>PostJson网址：<a href="http://coolaf.com/tool/post">http://coolaf.com/tool/post</a></p><p>我们将第二步获取的数据填入对应的模块中，它这里用的是Post传参，通过表单进行提交，application/x-www-form-urlencoded，在PostJson中我们选择x-www-form-urlencoded，Cookie选择AREA，输入Cookie，也就是第二步请求头中的Cookies，Headers对应第二步请求头的信息。</p><p><img src="https://i.loli.net/2021/07/02/MBt9PTVsaUwq6kf.png" alt="PostJson"></p><p>点击提交，可以看到，它返回了网站的源代码，效果和我们在查询页面右键点击查看网页源代码一样。</p><h2 id="四、分析网页"><a href="#四、分析网页" class="headerlink" title="四、分析网页"></a>四、分析网页</h2><p><img src="https://i.loli.net/2021/07/02/8kCV7IYUGBrAtWn.png" alt="公司信息表"></p><p>可以看到，总共有12519家公司，而这里采取的分页查询，所以之后我们在进行代码编写的时候，要动态的改变页码参数去循环获取每页的数据。图中表格中的内容就是我们需要的公司信息，右键查看网页源代码。我们找到表格的部分，发现这个表格的id=‘search’，除去第一个为表头，每个公司都在这个表格中占一个。</p><h2 id="五、代码编写"><a href="#五、代码编写" class="headerlink" title="五、代码编写"></a>五、代码编写</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> requests<span class="token keyword">from</span> bs4 <span class="token keyword">import</span> BeautifulSoup<span class="token comment" spellcheck="true">#全局变量</span>Num <span class="token operator">=</span> <span class="token number">0</span><span class="token comment" spellcheck="true">#获取网站信息</span><span class="token keyword">def</span> <span class="token function">getHTMLText</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span>page<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        <span class="token comment" spellcheck="true">#访问网站需要的数据参数</span>        data <span class="token operator">=</span> <span class="token punctuation">{</span>            <span class="token string">'params'</span><span class="token punctuation">:</span>page<span class="token punctuation">,</span>            <span class="token string">'hfCond'</span><span class="token punctuation">:</span><span class="token string">'3mLVm+1L2TF3qSHhXVWLKO2UWAiGJtJ7tzx5ZHVkjZss7jxUSh1jh0ECe+YsZSuzlTMpAfvEs/stliWTLD/MP/D1zphgZT7Fyfpuc5N32Tw='</span><span class="token punctuation">,</span>            <span class="token string">'curPage'</span><span class="token punctuation">:</span><span class="token string">'1'</span><span class="token punctuation">,</span>            <span class="token string">'cbTokyo'</span><span class="token punctuation">:</span><span class="token string">'1'</span><span class="token punctuation">,</span>            <span class="token string">'ucKyokatodokedeNo1'</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>            <span class="token string">'txtKyokatodokedeNo2'</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>            <span class="token string">'txtKyokatodokedeNo3'</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true"># 'nm_btnSearch.x': '88',</span>            <span class="token comment" spellcheck="true"># 'nm_btnSearch.y': '26',</span>            <span class="token string">'hfJigyoshoRegKbn'</span><span class="token punctuation">:</span> <span class="token string">'0'</span><span class="token punctuation">,</span>            <span class="token string">'hfScrollTop'</span><span class="token punctuation">:</span> <span class="token string">'1500'</span><span class="token punctuation">,</span>            <span class="token string">'screenId'</span><span class="token punctuation">:</span> <span class="token string">'GICB102010'</span><span class="token punctuation">,</span>            <span class="token string">'action'</span><span class="token punctuation">:</span> <span class="token string">'page'</span><span class="token punctuation">,</span>            <span class="token string">'codeAssistType'</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>            <span class="token string">'codeAssistKind'</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>            <span class="token string">'codeAssistCode'</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>            <span class="token string">'codeAssistItemCode'</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>            <span class="token string">'codeAssistItemName'</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>            <span class="token string">'codeAssistDivide'</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>            <span class="token string">'maba_vrbs'</span><span class="token punctuation">:</span><span class="token string">''</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">#头部协议</span>        headers <span class="token operator">=</span> <span class="token punctuation">{</span>            <span class="token string">'Accept'</span><span class="token punctuation">:</span><span class="token string">'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9'</span><span class="token punctuation">,</span>            <span class="token string">'Accept-Encoding'</span><span class="token punctuation">:</span><span class="token string">'gzip, deflate, br'</span><span class="token punctuation">,</span>            <span class="token string">'Accept-Language'</span><span class="token punctuation">:</span><span class="token string">'ja,en-US;q=0.9,en;q=0.8,zh-CN;q=0.7,zh;q=0.6'</span><span class="token punctuation">,</span>            <span class="token string">'Cache-Control'</span><span class="token punctuation">:</span><span class="token string">'max-age=0'</span><span class="token punctuation">,</span>            <span class="token string">'Connection'</span><span class="token punctuation">:</span><span class="token string">'keep-alive'</span><span class="token punctuation">,</span>            <span class="token string">'Content-Length'</span><span class="token punctuation">:</span><span class="token string">'440'</span><span class="token punctuation">,</span>            <span class="token string">'Content-Type'</span><span class="token punctuation">:</span><span class="token string">'application/x-www-form-urlencoded'</span><span class="token punctuation">,</span>            <span class="token string">'Cookie'</span><span class="token punctuation">:</span><span class="token string">'JSESSIONID=tnokZeolLdfwYSKnpNpNT34yVuwNXF4W6o68yuN1Cs_mup_yrQai0Nfap8b-0EDR.ICB_001'</span>        <span class="token punctuation">}</span>        r <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span>        r<span class="token punctuation">.</span>raise_for_status<span class="token punctuation">(</span><span class="token punctuation">)</span>        r<span class="token punctuation">.</span>encoding <span class="token operator">=</span> r<span class="token punctuation">.</span>apparent_encoding        <span class="token keyword">return</span> r<span class="token punctuation">.</span>text    <span class="token keyword">except</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">""</span><span class="token comment" spellcheck="true">#循环进行分页操作获取数据</span><span class="token keyword">def</span> <span class="token function">get_html</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span>fpath<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">626</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        page <span class="token operator">=</span> i<span class="token operator">+</span><span class="token number">1</span>        html <span class="token operator">=</span> getHTMLText<span class="token punctuation">(</span>url<span class="token punctuation">,</span> page<span class="token punctuation">)</span>        getCompany<span class="token punctuation">(</span>html<span class="token punctuation">,</span>fpath<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#获取每页的公司信息</span><span class="token keyword">def</span> <span class="token function">getCompany</span><span class="token punctuation">(</span>html<span class="token punctuation">,</span> fpath<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">global</span> Num    soup <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>html<span class="token punctuation">,</span><span class="token string">'html.parser'</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">#找到公司信息的表格</span>    table <span class="token operator">=</span> soup<span class="token punctuation">.</span>find<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token string">'search'</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">#除去表头，对每一行进行循环</span>    <span class="token keyword">for</span> tr <span class="token keyword">in</span> table<span class="token punctuation">.</span>find_all<span class="token punctuation">(</span><span class="token string">'tr'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            infoDict <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>            infoDict<span class="token punctuation">[</span><span class="token string">'Num'</span><span class="token punctuation">]</span> <span class="token operator">=</span> Num            infoDict<span class="token punctuation">[</span><span class="token string">'許可・受理番号'</span><span class="token punctuation">]</span> <span class="token operator">=</span> tr<span class="token punctuation">.</span>find<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token string">'ID_lbKyokatodokedeNo'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>string            infoDict<span class="token punctuation">[</span><span class="token string">'許可年月日・届出受理年月日'</span><span class="token punctuation">]</span> <span class="token operator">=</span> tr<span class="token punctuation">.</span>find<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token string">'ID_lbKyokatodokedeDate'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>string            infoDict<span class="token punctuation">[</span><span class="token string">'事業主名称'</span><span class="token punctuation">]</span> <span class="token operator">=</span> tr<span class="token punctuation">.</span>find<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token string">'ID_lbJigyonushiName'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>string<span class="token punctuation">.</span>replace<span class="token punctuation">(</span>u<span class="token string">'\u3000'</span><span class="token punctuation">,</span> u<span class="token string">''</span><span class="token punctuation">)</span>            infoDict<span class="token punctuation">[</span><span class="token string">'事業所名称'</span><span class="token punctuation">]</span> <span class="token operator">=</span> tr<span class="token punctuation">.</span>find<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token string">'ID_lbJigyoshoName'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>string<span class="token punctuation">.</span>replace<span class="token punctuation">(</span>u<span class="token string">'\u3000'</span><span class="token punctuation">,</span> u<span class="token string">''</span><span class="token punctuation">)</span>            infoDict<span class="token punctuation">[</span><span class="token string">'事業所所在地'</span><span class="token punctuation">]</span> <span class="token operator">=</span> tr<span class="token punctuation">.</span>find<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token string">'ID_lbJigyoshoAddress'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>string<span class="token punctuation">.</span>replace<span class="token punctuation">(</span>u<span class="token string">'\u3000'</span><span class="token punctuation">,</span> u<span class="token string">''</span><span class="token punctuation">)</span>            infoDict<span class="token punctuation">[</span><span class="token string">'電話番号'</span><span class="token punctuation">]</span> <span class="token operator">=</span> tr<span class="token punctuation">.</span>find<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token string">'ID_lbTel'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>string            Num <span class="token operator">=</span> Num <span class="token operator">+</span> <span class="token number">1</span>            <span class="token keyword">if</span> tr<span class="token punctuation">.</span>find<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token string">'ID_lbRyokinaveValue'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                infoDict<span class="token punctuation">[</span><span class="token string">'派遣料金の平均額'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>tr<span class="token punctuation">.</span>find<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token string">'ID_lbRyokinaveValue'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span>stripped_strings<span class="token punctuation">)</span>            <span class="token keyword">if</span> tr<span class="token punctuation">.</span>find<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token string">'ID_lbChinginaveValue'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                infoDict<span class="token punctuation">[</span><span class="token string">'派遣労働者の賃金の平均額'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>tr<span class="token punctuation">.</span>find<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token string">'ID_lbChinginaveValue'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span>stripped_strings<span class="token punctuation">)</span>            <span class="token keyword">if</span> tr<span class="token punctuation">.</span>find<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token string">'ID_lbPMargin'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                infoDict<span class="token punctuation">[</span><span class="token string">'マージン率'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>tr<span class="token punctuation">.</span>find<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token string">'ID_lbPMargin'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span>stripped_strings<span class="token punctuation">)</span>            <span class="token keyword">if</span> tr<span class="token punctuation">.</span>find<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token string">'ID_lbRoshikyoteiShuuki'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                infoDict<span class="token punctuation">[</span><span class="token string">'労使協定の締結'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>tr<span class="token punctuation">.</span>find<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token string">'ID_lbRoshikyoteiShuuki'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span>stripped_strings<span class="token punctuation">)</span>            <span class="token keyword">if</span> tr<span class="token punctuation">.</span>find<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token string">'ID_lbYuryou'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                infoDict<span class="token punctuation">[</span><span class="token string">'備考'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>tr<span class="token punctuation">.</span>find<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token string">'ID_lbYuryou'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span>stripped_strings<span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>infoDict<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">#保存到文件中</span>            <span class="token keyword">with</span> open<span class="token punctuation">(</span>fpath<span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>                f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>str<span class="token punctuation">(</span>infoDict<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>        <span class="token keyword">except</span><span class="token punctuation">:</span>            <span class="token keyword">continue</span><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true">#爬取的网站信息</span>    url <span class="token operator">=</span> <span class="token string">'https://jinzai.hellowork.mhlw.go.jp/JinzaiWeb/GICB102010.do'</span>    <span class="token comment" spellcheck="true">#文件保存的地址</span>    output_file <span class="token operator">=</span> <span class="token string">'D://python//data//info.txt'</span>    get_html<span class="token punctuation">(</span>url<span class="token punctuation">,</span>output_file<span class="token punctuation">)</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> 技术文档 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> js </tag>
            
            <tag> Html </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BigQuant代码锦集</title>
      <link href="2021/06/25/bigquant-dai-ma-jin-ji/"/>
      <url>2021/06/25/bigquant-dai-ma-jin-ji/</url>
      
        <content type="html"><![CDATA[<h1 id="BigQuant代码锦集"><a href="#BigQuant代码锦集" class="headerlink" title="BigQuant代码锦集"></a>BigQuant代码锦集</h1><p> 这里是平常工作中会用到的一些常用的代码集合，不定时的更新❀</p><hr><h4 id="股票池中去除获取创业板代码"><a href="#股票池中去除获取创业板代码" class="headerlink" title="股票池中去除获取创业板代码"></a>股票池中去除获取创业板代码</h4><pre class=" language-python"><code class="language-python">all_ins <span class="token operator">=</span> D<span class="token punctuation">.</span>instruments<span class="token punctuation">(</span>start_date<span class="token operator">=</span><span class="token string">'2017-09-07'</span><span class="token punctuation">,</span>end_date<span class="token operator">=</span><span class="token string">'2018-09-07'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#创业板代码一般以3开头</span>ins <span class="token operator">=</span> <span class="token punctuation">[</span>k <span class="token keyword">for</span> k <span class="token keyword">in</span> all_ins <span class="token keyword">if</span> k<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">'8'</span><span class="token punctuation">]</span></code></pre><h4 id="求股票的真实价格"><a href="#求股票的真实价格" class="headerlink" title="求股票的真实价格"></a>求股票的真实价格</h4><pre class=" language-python"><code class="language-python">start <span class="token operator">=</span> <span class="token string">'2018-11-23'</span>end <span class="token operator">=</span> <span class="token string">'2019-12-20'</span>features_data <span class="token operator">=</span> D<span class="token punctuation">.</span>features<span class="token punctuation">(</span>D<span class="token punctuation">.</span>instruments<span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'close_0'</span><span class="token punctuation">,</span><span class="token string">'close_1'</span><span class="token punctuation">,</span><span class="token string">'close_2'</span><span class="token punctuation">,</span><span class="token string">'volume_0'</span><span class="token punctuation">,</span><span class="token string">'industry_sw_level1_0'</span><span class="token punctuation">,</span><span class="token string">'daily_return_0'</span><span class="token punctuation">,</span><span class="token string">'adjust_factor_0'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>features_data <span class="token operator">=</span> features_data<span class="token punctuation">[</span>features_data<span class="token punctuation">[</span><span class="token string">'instrument'</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">'002679.SZA'</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true"># features_data['date'] = pd.to_datetime(features_data['date']) #将数据类型转换为日期类型</span>features_data <span class="token operator">=</span> features_data<span class="token punctuation">.</span>set_index<span class="token punctuation">(</span><span class="token string">'date'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 将date设置为index</span>features_data <span class="token operator">=</span> features_data<span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span><span class="token string">'date'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#获取真实价格</span>features_data<span class="token punctuation">[</span><span class="token string">'close_0'</span><span class="token punctuation">]</span> <span class="token operator">/=</span> features_data<span class="token punctuation">[</span><span class="token string">'adjust_factor_0'</span><span class="token punctuation">]</span>features_data<span class="token punctuation">[</span><span class="token string">'close_1'</span><span class="token punctuation">]</span> <span class="token operator">/=</span> features_data<span class="token punctuation">[</span><span class="token string">'adjust_factor_0'</span><span class="token punctuation">]</span>features_data<span class="token punctuation">[</span><span class="token string">'close_2'</span><span class="token punctuation">]</span> <span class="token operator">/=</span> features_data<span class="token punctuation">[</span><span class="token string">'adjust_factor_0'</span><span class="token punctuation">]</span></code></pre><h4 id="筛选申万行业一的数据"><a href="#筛选申万行业一的数据" class="headerlink" title="筛选申万行业一的数据"></a>筛选申万行业一的数据</h4><pre class=" language-python"><code class="language-python">bar1d <span class="token operator">=</span> DataSource<span class="token punctuation">(</span><span class="token string">"bar1d_index_CN_STOCK_A"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span>start_date<span class="token operator">=</span>start<span class="token punctuation">,</span>end_date<span class="token operator">=</span>end<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#指数行情</span>bar1d_sw <span class="token operator">=</span> bar1d<span class="token punctuation">[</span>bar1d<span class="token punctuation">.</span>instrument<span class="token punctuation">.</span>str<span class="token punctuation">.</span>contains<span class="token punctuation">(</span><span class="token string">"SW"</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># 筛选出申万行业指数</span>bar1d_sw<span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">]</span> <span class="token operator">=</span> bar1d_sw<span class="token punctuation">[</span><span class="token string">'instrument'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>apply<span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>basic_info_sw <span class="token operator">=</span> DataSource<span class="token punctuation">(</span><span class="token string">"basic_info_IndustrySw"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 读取申万行业基本信息数据</span>basic_info_sw<span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"SW"</span> <span class="token operator">+</span> basic_info_sw<span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">]</span>df3 <span class="token operator">=</span> bar1d_sw<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>basic_info_sw<span class="token punctuation">,</span> on<span class="token operator">=</span><span class="token string">'code'</span><span class="token punctuation">,</span> how<span class="token operator">=</span><span class="token string">'left'</span><span class="token punctuation">)</span></code></pre><h4 id="展开全部行-列"><a href="#展开全部行-列" class="headerlink" title="展开全部行/列"></a>展开全部行/列</h4><pre class=" language-python"><code class="language-python">pd<span class="token punctuation">.</span>set_option<span class="token punctuation">(</span><span class="token string">'display.max_columns'</span><span class="token punctuation">,</span> None<span class="token punctuation">)</span>pd<span class="token punctuation">.</span>set_option<span class="token punctuation">(</span><span class="token string">'display.max_rows'</span><span class="token punctuation">,</span> None<span class="token punctuation">)</span></code></pre><h4 id="计算均值"><a href="#计算均值" class="headerlink" title="计算均值"></a>计算均值</h4><pre class=" language-python"><code class="language-python">df<span class="token punctuation">[</span><span class="token string">'mean_5'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rolling<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>df<span class="token punctuation">[</span><span class="token string">'mean_10'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rolling<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>df<span class="token punctuation">[</span><span class="token string">'mean_20'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rolling<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>df<span class="token punctuation">[</span><span class="token string">'mean_60'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rolling<span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>df<span class="token punctuation">[</span><span class="token string">'mean_120'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rolling<span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h4 id="计算角度"><a href="#计算角度" class="headerlink" title="计算角度"></a>计算角度</h4><pre class=" language-python"><code class="language-python">df<span class="token punctuation">[</span><span class="token string">'arctan_5'</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>arctan<span class="token punctuation">(</span><span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'mean_5'</span><span class="token punctuation">]</span><span class="token operator">/</span>df<span class="token punctuation">[</span><span class="token string">'mean_5'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shift<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">180</span><span class="token operator">/</span><span class="token number">3.1416</span>df<span class="token punctuation">[</span><span class="token string">'arctan_10'</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>arctan<span class="token punctuation">(</span><span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'mean_10'</span><span class="token punctuation">]</span><span class="token operator">/</span>df<span class="token punctuation">[</span><span class="token string">'mean_10'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shift<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">180</span><span class="token operator">/</span><span class="token number">3.1416</span>df<span class="token punctuation">[</span><span class="token string">'arctan_20'</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>arctan<span class="token punctuation">(</span><span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'mean_20'</span><span class="token punctuation">]</span><span class="token operator">/</span>df<span class="token punctuation">[</span><span class="token string">'mean_20'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shift<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">180</span><span class="token operator">/</span><span class="token number">3.1416</span>df<span class="token punctuation">[</span><span class="token string">'arctan_60'</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>arctan<span class="token punctuation">(</span><span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'mean_60'</span><span class="token punctuation">]</span><span class="token operator">/</span>df<span class="token punctuation">[</span><span class="token string">'mean_60'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shift<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">180</span><span class="token operator">/</span><span class="token number">3.1416</span>df<span class="token punctuation">[</span><span class="token string">'arctan_120'</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>arctan<span class="token punctuation">(</span><span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'mean_120'</span><span class="token punctuation">]</span><span class="token operator">/</span>df<span class="token punctuation">[</span><span class="token string">'mean_120'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shift<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">180</span><span class="token operator">/</span><span class="token number">3.1416</span></code></pre><h4 id="计算振幅"><a href="#计算振幅" class="headerlink" title="计算振幅"></a>计算振幅</h4><pre class=" language-python"><code class="language-python">df<span class="token punctuation">[</span><span class="token string">'max_30'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'high'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rolling<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">.</span>max<span class="token punctuation">(</span><span class="token punctuation">)</span>df<span class="token punctuation">[</span><span class="token string">'min_30'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'low'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rolling<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">.</span>min<span class="token punctuation">(</span><span class="token punctuation">)</span>df<span class="token punctuation">[</span><span class="token string">'daily_30'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'max_30'</span><span class="token punctuation">]</span><span class="token operator">/</span>df<span class="token punctuation">[</span><span class="token string">'min_30'</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">1</span></code></pre><h4 id="获取指数成分股股票代码"><a href="#获取指数成分股股票代码" class="headerlink" title="获取指数成分股股票代码"></a>获取指数成分股股票代码</h4><pre class=" language-python"><code class="language-python">date<span class="token operator">=</span><span class="token string">'2017-05-23'</span>df <span class="token operator">=</span> D<span class="token punctuation">.</span>history_data<span class="token punctuation">(</span>D<span class="token punctuation">.</span>instruments<span class="token punctuation">(</span>date<span class="token punctuation">,</span>date<span class="token punctuation">)</span><span class="token punctuation">,</span>date<span class="token punctuation">,</span>date<span class="token punctuation">,</span>fields<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'in_csi300'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>hs300 <span class="token operator">=</span> set<span class="token punctuation">(</span>df<span class="token punctuation">[</span>df<span class="token punctuation">[</span><span class="token string">'in_csi300'</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'instrument'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre><h4 id="禁用缓存"><a href="#禁用缓存" class="headerlink" title="禁用缓存"></a>禁用缓存</h4><pre class=" language-python"><code class="language-python">m1 <span class="token operator">=</span> M<span class="token punctuation">.</span>cached<span class="token punctuation">.</span>v2<span class="token punctuation">(</span>run<span class="token operator">=</span>foo1<span class="token punctuation">,</span>kwargs<span class="token operator">=</span>dict<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'quant'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>m_cached<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></code></pre><h4 id="获取板块名称列表"><a href="#获取板块名称列表" class="headerlink" title="获取板块名称列表"></a>获取板块名称列表</h4><pre class=" language-python"><code class="language-python">instruments <span class="token operator">=</span> D<span class="token punctuation">.</span>instruments<span class="token punctuation">(</span><span class="token punctuation">)</span>df <span class="token operator">=</span> D<span class="token punctuation">.</span>history_data<span class="token punctuation">(</span>instruments<span class="token punctuation">,</span>start_date<span class="token operator">=</span><span class="token string">'2017-05-19'</span><span class="token punctuation">,</span>end_date<span class="token operator">=</span><span class="token string">'2017-05-19'</span><span class="token punctuation">,</span>fields<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'concept'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>set<span class="token punctuation">(</span><span class="token punctuation">[</span>y <span class="token keyword">for</span> x <span class="token keyword">in</span> df<span class="token punctuation">[</span><span class="token string">'concept'</span><span class="token punctuation">]</span> <span class="token keyword">if</span> x <span class="token keyword">for</span> y <span class="token keyword">in</span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">';'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre><h4 id="获取指定板块数据"><a href="#获取指定板块数据" class="headerlink" title="获取指定板块数据"></a>获取指定板块数据</h4><pre class=" language-python"><code class="language-python">instruments <span class="token operator">=</span> D<span class="token punctuation">.</span>instruments<span class="token punctuation">(</span><span class="token punctuation">)</span>df <span class="token operator">=</span> D<span class="token punctuation">.</span>history_data<span class="token punctuation">(</span>instruments<span class="token punctuation">,</span>start_date<span class="token operator">=</span><span class="token string">'2017-05-19'</span><span class="token punctuation">,</span>end_date<span class="token operator">=</span><span class="token string">'2017-05-19'</span><span class="token punctuation">,</span>fields<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'concept'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>df<span class="token punctuation">[</span>df<span class="token punctuation">[</span><span class="token string">'concept'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>apply<span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span><span class="token string">'智能家居'</span> <span class="token keyword">in</span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">';'</span><span class="token punctuation">)</span> <span class="token keyword">if</span> x <span class="token keyword">else</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code></pre><h4 id="回测交易"><a href="#回测交易" class="headerlink" title="回测交易"></a>回测交易</h4><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># 证券池：这里使用所有股票</span>instruments <span class="token operator">=</span> D<span class="token punctuation">.</span>instruments<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># 起始日期</span>start_date <span class="token operator">=</span> <span class="token string">'2018-06-01'</span><span class="token comment" spellcheck="true"># 结束日期</span>end_date <span class="token operator">=</span> <span class="token string">'2020-11-24'</span><span class="token comment" spellcheck="true"># 初始资金</span>capital_base <span class="token operator">=</span> <span class="token number">1000000</span><span class="token comment" spellcheck="true"># 策略比较参考标准，以沪深300为例</span>benchmark <span class="token operator">=</span> <span class="token string">'000300.INDX'</span><span class="token comment" spellcheck="true"># 调仓周期（多少个交易日调仓）</span>rebalance_period <span class="token operator">=</span> <span class="token number">1</span>m <span class="token operator">=</span> M<span class="token punctuation">.</span>trade<span class="token punctuation">.</span>v3<span class="token punctuation">(</span>    instruments<span class="token operator">=</span>instruments<span class="token punctuation">,</span>    start_date<span class="token operator">=</span>start_date<span class="token punctuation">,</span>    end_date<span class="token operator">=</span>end_date<span class="token punctuation">,</span>    initialize<span class="token operator">=</span>initialize<span class="token punctuation">,</span>    handle_data<span class="token operator">=</span>handle_data<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true"># 买入订单以收盘价成交</span>    order_price_field_buy<span class="token operator">=</span><span class="token string">'close'</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true"># 卖出订单以开盘价成交</span>    order_price_field_sell<span class="token operator">=</span><span class="token string">'open'</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">#     price_type='真实价格',</span>    capital_base<span class="token operator">=</span>capital_base<span class="token punctuation">,</span>    benchmark<span class="token operator">=</span>benchmark<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true"># 传入数据给回测模块，所有回测函数里用到的数据都要从这里传入，并通过 context.options 使用，否则可能会遇到缓存问题</span>    options<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'selected_data'</span><span class="token punctuation">:</span> selected_data<span class="token punctuation">,</span> <span class="token string">'rebalance_period'</span><span class="token punctuation">:</span> rebalance_period<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> 技术文档 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bigquant </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>画展</title>
      <link href="2021/06/25/hua-zhan/"/>
      <url>2021/06/25/hua-zhan/</url>
      
        <content type="html"><![CDATA[<h1 id="画展"><a href="#画展" class="headerlink" title="画展"></a>画展</h1><hr><p>小白画手偶尔心血来潮的作品，时间按降序排序，喜欢的可以自取~</p><h2 id="2021年6月30日"><a href="#2021年6月30日" class="headerlink" title="2021年6月30日"></a>2021年6月30日</h2><p><img src="https://i.loli.net/2021/07/02/Eh1qWPnbMjGacfx.jpg" alt="彩虹"></p><h2 id="2021年6月20日"><a href="#2021年6月20日" class="headerlink" title="2021年6月20日"></a>2021年6月20日</h2><p><img src="https://i.loli.net/2021/07/02/oV7bLAMy34WGcRx.jpg" alt="干杯！🍻"></p><h2 id="2021年6月12日"><a href="#2021年6月12日" class="headerlink" title="2021年6月12日"></a>2021年6月12日</h2><p><img src="https://i.loli.net/2021/07/02/PT7e54YQdyoql3t.jpg" alt="万事顺“荔”"></p><h2 id="2021年5月23日"><a href="#2021年5月23日" class="headerlink" title="2021年5月23日"></a>2021年5月23日</h2><p><img src="https://i.loli.net/2021/06/25/SXfycNaFwrM17UP.jpg" alt="スイカ！🍉"></p><h2 id="2021年4月15日"><a href="#2021年4月15日" class="headerlink" title="2021年4月15日"></a>2021年4月15日</h2><p><img src="https://i.loli.net/2021/07/02/GOp8snXZmzVQJM1.jpg" alt="午后"></p><h2 id="2021年2月10日"><a href="#2021年2月10日" class="headerlink" title="2021年2月10日"></a>2021年2月10日</h2><p><img src="https://i.loli.net/2021/07/02/EtmoKp1bZqaw9vY.jpg" alt="冰淇淋！🍦"></p><h2 id="2020年12月1日"><a href="#2020年12月1日" class="headerlink" title="2020年12月1日"></a>2020年12月1日</h2><p><img src="https://i.loli.net/2021/07/02/lxjA3zuOaJi41W5.jpg" alt="月亮！🌙"></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
        <tags>
            
            <tag> 画 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android平台整合H5WebApp，集成企业微信SDK</title>
      <link href="2021/01/22/android-ping-tai-zheng-he-h5webapp-ji-cheng-qi-ye-wei-xin-sdk/"/>
      <url>2021/01/22/android-ping-tai-zheng-he-h5webapp-ji-cheng-qi-ye-wei-xin-sdk/</url>
      
        <content type="html"><![CDATA[<h1 id="Android平台整合H5WebApp，集成企业微信SDK"><a href="#Android平台整合H5WebApp，集成企业微信SDK" class="headerlink" title="Android平台整合H5WebApp，集成企业微信SDK"></a>Android平台整合H5WebApp，集成企业微信SDK</h1><h3 id="一、整合前准备"><a href="#一、整合前准备" class="headerlink" title="一、整合前准备"></a>一、整合前准备</h3><ol><li><p>下载<a href="https://nativesupport.dcloud.net.cn/AppDocs/download/android">AndroidSDK</a></p></li><li><p><a href="https://work.weixin.qq.com/api/doc/90000/90138/91074">企业微信移动端SDK</a>资源下载，将签名生成工具安装在手机端，之后在获取企业微信登录权限时需要用到。</p><blockquote><p>使用企业微信登录、分享功能需要用到文件如下。<br>点击下载<a href="http://open.work.weixin.qq.com/wwopen/downloadfile/wwapi.zip">Android开发工具包集合</a> 。每个第三方应用必须要导入该SDK库，用于实现与企业微信的通信<br>点击下载 <a href="http://dldir1.qq.com/qqcontacts/Gen_Signature_Android.apk">签名生成工具</a>。安装此工具，根据指引生成的应用签名字符串并填写在应用管理平台上，未填写或者填写错误将导致接口无法使用。<br>点击下载<a href="http://dldir1.qq.com/qqcontacts/apitest_2.zip">接口使用Demo</a>。开发者可以参考Demo中的接口使用方式进行开发。</p></blockquote></li><li><p>必要开发软件自行下载</p><ul><li>Android studio</li><li>Hbuilder</li></ul></li></ol><h3 id="二、导入AndroidDemo"><a href="#二、导入AndroidDemo" class="headerlink" title="二、导入AndroidDemo"></a>二、导入AndroidDemo</h3><ol><li><p>sdk目录         </p><p><img src="https://i.loli.net/2021/01/22/9bTciu8DAyv1kNS.png"> </p></li><li><p>将HBuilder-Hello导入Android Studio，在导入过程中可能会出现各种奇奇怪怪的问题，请自行百度解决，在这里提供一些可能会出现问题的解决方法</p><ul><li><p><strong>Error:Connection timed out: connect. If you are behind an HTTP proxy, please configure the proxy settings either in IDE or Gradle.</strong></p><p>由于网络原因，无法下载gradle，解决办法：</p><p>在项目目录，“<em>\gradle\wrapper\gradle-wrapper.properties</em>”中查看当前项目所需要的gradle版本号，如下所示：gradle的版本为gradle-6.5-all.zip</p><p><code>distributionUrl=https\://services.gradle.org/distributions/gradle-6.5-all.zip</code></p><p>在<a href="https://www.androiddevtools.cn/">androiddevtools</a>中下载对应的gradle包，下载好之后直接丢进”<em>C:\Users\zora\.gradle\wrapper\dists\gradle-6.5-all\&lt;随机生成的字符串&gt;</em>“里面，重新运行Android Studio</p></li><li><p><strong>Error:Cause: failed to find target with hash string ‘android-23’</strong></p><p>缺少对应的SDK文件，解决方法：在Android Studio中打开”File&gt;Settings“,搜索sdk，下载对应的sdk文件，重新rebuild项目。</p></li></ul></li></ol><h3 id="三、整合webApp"><a href="#三、整合webApp" class="headerlink" title="三、整合webApp"></a>三、整合webApp</h3><p>官方离线打包参考链接：<a href="https://nativesupport.dcloud.net.cn/AppDocs/usesdk/android">Android离线打包</a></p><ol><li><p>​    打包H5+APP</p><p>在HBuilder中，打包成本地资源，将资源文件放在HBuilder-Hello的”<em>\app\src\main\assets\apps&lt;webApp对应id，在manifest.json中查看&gt;\www</em>“中，如果没有该文件夹则创建一个www空文件夹。</p><p><img src="https://i.loli.net/2021/01/22/YTknLBd324DbVgN.png">  <img src="https://i.loli.net/2021/01/22/sxlPiqzvEt2OR1d.png"></p></li><li><p>修改dcloud_control.xml中的appid，appid就是在manifest.json文件中定义的id，<strong>与apps下的文件夹同名</strong>。</p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hbuilder</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>apps</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>app</span> <span class="token attr-name">appid</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>H******E<span class="token punctuation">"</span></span> <span class="token attr-name">appver</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>apps</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>hbuilder</span><span class="token punctuation">></span></span></code></pre></li><li><p>运行项目</p><p><img src="https://i.loli.net/2021/01/22/GdxfWMEgAlmUY6j.png"> </p></li></ol><h3 id="四、整合企业微信SDK"><a href="#四、整合企业微信SDK" class="headerlink" title="四、整合企业微信SDK"></a>四、整合企业微信SDK</h3><p>官方sdk整合链接：<a href="https://work.weixin.qq.com/api/doc/90000/90136/91194">Android接入指南</a></p><ol><li><p>在下载好的企业微信Demo中，将”<em>\apitest_2\apitest\app\libs</em>“中的libwwsdk.jar复制到HBuilder-Hello的libs文件夹中，这样就成功的引入了企业微信sdk</p></li><li><p>进行代码开发，官方给出的代码对与纯Android原生开发的应用是没有问题的！但是，我们是整合了webAPP进行的混合开发！<span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f622.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f622.png?v8">😢</span></p><p>这里我找遍全网都没找到解决方法，可能是企业微信集成的需求不大？踩了很多坑，在看了一天的源码之后，摸索出一条解决办法，因为AndroidSDK中是提供了微信、qq等第三方登录接口的，所以我依葫芦画瓢，增加了一个企业微信的登录接口。可以参考<a href="https://ask.dcloud.net.cn/article/66">Android平台第三方插件开发指导</a></p><ul><li><p>在”<em>java\io\dcloud\HelloH5\wxapi</em>“中新建类<strong>QyWeiXinOAuthService.java</strong>继承<strong>BaseOAuthService</strong>，具体代码如下</p><pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> io<span class="token punctuation">.</span>dcloud<span class="token punctuation">.</span>HelloH5<span class="token punctuation">.</span>wxapi<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>Context<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>text<span class="token punctuation">.</span>TextUtils<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>Toast<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>wework<span class="token punctuation">.</span>api<span class="token punctuation">.</span>IWWAPI<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>wework<span class="token punctuation">.</span>api<span class="token punctuation">.</span>IWWAPIEventHandler<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>wework<span class="token punctuation">.</span>api<span class="token punctuation">.</span>WWAPIFactory<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>wework<span class="token punctuation">.</span>api<span class="token punctuation">.</span>model<span class="token punctuation">.</span>BaseMessage<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>wework<span class="token punctuation">.</span>api<span class="token punctuation">.</span>model<span class="token punctuation">.</span>WWAuthMessage<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>json<span class="token punctuation">.</span>JSONArray<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>json<span class="token punctuation">.</span>JSONException<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>json<span class="token punctuation">.</span>JSONObject<span class="token punctuation">;</span><span class="token keyword">import</span> io<span class="token punctuation">.</span>dcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>DHInterface<span class="token punctuation">.</span>IWebview<span class="token punctuation">;</span><span class="token keyword">import</span> io<span class="token punctuation">.</span>dcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>adapter<span class="token punctuation">.</span>util<span class="token punctuation">.</span>AndroidResources<span class="token punctuation">;</span><span class="token keyword">import</span> io<span class="token punctuation">.</span>dcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>adapter<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Logger<span class="token punctuation">;</span><span class="token keyword">import</span> io<span class="token punctuation">.</span>dcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>adapter<span class="token punctuation">.</span>util<span class="token punctuation">.</span>PlatformUtil<span class="token punctuation">;</span><span class="token keyword">import</span> io<span class="token punctuation">.</span>dcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>constant<span class="token punctuation">.</span>DOMException<span class="token punctuation">;</span><span class="token keyword">import</span> io<span class="token punctuation">.</span>dcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>util<span class="token punctuation">.</span>JSUtil<span class="token punctuation">;</span><span class="token keyword">import</span> io<span class="token punctuation">.</span>dcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>util<span class="token punctuation">.</span>StringUtil<span class="token punctuation">;</span><span class="token keyword">import</span> io<span class="token punctuation">.</span>dcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>util<span class="token punctuation">.</span>ThreadPool<span class="token punctuation">;</span><span class="token keyword">import</span> io<span class="token punctuation">.</span>dcloud<span class="token punctuation">.</span>feature<span class="token punctuation">.</span>oauth<span class="token punctuation">.</span>BaseOAuthService<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QyWeiXinOAuthService</span> <span class="token keyword">extends</span> <span class="token class-name">BaseOAuthService</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> IWWAPI iwwapi<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//企业微信api</span>    <span class="token keyword">private</span> String code<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String TAG <span class="token operator">=</span> <span class="token string">"QyWeiXinOAuthService"</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String SCHEMA <span class="token operator">=</span> <span class="token string">"wwauth***********000006"</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//企业微信授权登录中的SCHEMA，获取方法请参考步骤六</span>    <span class="token keyword">protected</span> <span class="token keyword">static</span> String appId <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token keyword">protected</span> <span class="token keyword">static</span> String agentId <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> isAuth <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">QyWeiXinOAuthService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasFullConfigData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token operator">!</span>TextUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>appId<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initAuthOptions</span><span class="token punctuation">(</span>JSONObject mLoginOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mLoginOptions <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            appId <span class="token operator">=</span> mLoginOptions<span class="token punctuation">.</span><span class="token function">optString</span><span class="token punctuation">(</span><span class="token string">"appid"</span><span class="token punctuation">,</span> appId<span class="token punctuation">)</span><span class="token punctuation">;</span>            Logger<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"QyWeiXinOAuthService"</span><span class="token punctuation">,</span> <span class="token string">"initAuthOptions: appId"</span> <span class="token operator">+</span> appId<span class="token punctuation">)</span><span class="token punctuation">;</span>            agentId <span class="token operator">=</span> mLoginOptions<span class="token punctuation">.</span><span class="token function">optString</span><span class="token punctuation">(</span><span class="token string">"agentId"</span><span class="token punctuation">,</span> agentId<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initMetaData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        appId <span class="token operator">=</span> AndroidResources<span class="token punctuation">.</span><span class="token function">getMetaValue</span><span class="token punctuation">(</span><span class="token string">"QYWX_APPID"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        agentId <span class="token operator">=</span> AndroidResources<span class="token punctuation">.</span><span class="token function">getMetaValue</span><span class="token punctuation">(</span><span class="token string">"QYWX_AGENTID"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token string">"qyweixin"</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>description <span class="token operator">=</span> <span class="token string">"企业微信"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">onLoginCallBack</span><span class="token punctuation">(</span>IWebview pWebViewImpl<span class="token punctuation">,</span> String pCallbackId<span class="token punctuation">,</span> <span class="token keyword">int</span> code<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">boolean</span> suc <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        String errorMsg <span class="token operator">=</span> <span class="token string">"send"</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">==</span> WWAuthMessage<span class="token punctuation">.</span>ERR_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>            suc <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">==</span> WWAuthMessage<span class="token punctuation">.</span>ERR_FAIL<span class="token punctuation">)</span> <span class="token punctuation">{</span>            errorMsg <span class="token operator">=</span> <span class="token string">"登录失败"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">==</span> WWAuthMessage<span class="token punctuation">.</span>ERR_CANCEL<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onLoginFinished</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getErrorJsonbject</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"用户取消"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> pWebViewImpl<span class="token punctuation">,</span> pCallbackId<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>suc<span class="token punctuation">)</span> <span class="token punctuation">{</span>            JSUtil<span class="token punctuation">.</span><span class="token function">execCallback</span><span class="token punctuation">(</span>pWebViewImpl<span class="token punctuation">,</span> pCallbackId<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">makeResultJSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> JSUtil<span class="token punctuation">.</span>OK<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            String msg <span class="token operator">=</span> DOMException<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">100</span><span class="token punctuation">,</span> errorMsg<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>            JSUtil<span class="token punctuation">.</span><span class="token function">execCallback</span><span class="token punctuation">(</span>pWebViewImpl<span class="token punctuation">,</span> pCallbackId<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> JSUtil<span class="token punctuation">.</span>ERROR<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">login</span><span class="token punctuation">(</span>IWebview pWebViewImpl<span class="token punctuation">,</span> JSONArray pJsArgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>pWebViewImpl<span class="token punctuation">,</span> pJsArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hasGeneralError</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mLoginWebViewImpl<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mLoginCallbackId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>PlatformUtil<span class="token punctuation">.</span><span class="token function">isAppInstalled</span><span class="token punctuation">(</span>pWebViewImpl<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"com.tencent.wework"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                String msg <span class="token operator">=</span> StringUtil<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"{code:%d,message:'%s'}"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">,</span> DOMException<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">"客户端未安装"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                JSUtil<span class="token punctuation">.</span><span class="token function">execCallback</span><span class="token punctuation">(</span>pWebViewImpl<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mLoginCallbackId<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> JSUtil<span class="token punctuation">.</span>ERROR<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                ThreadPool<span class="token punctuation">.</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addThreadTask</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        QyWeiXinOAuthService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loginInThread</span><span class="token punctuation">(</span>QyWeiXinOAuthService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mLoginWebViewImpl<span class="token punctuation">,</span> QyWeiXinOAuthService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mLoginCallbackId<span class="token punctuation">,</span> QyWeiXinOAuthService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mLoginOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">authorize</span><span class="token punctuation">(</span>IWebview pwebview<span class="token punctuation">,</span> JSONArray pJsArgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">authorize</span><span class="token punctuation">(</span>pwebview<span class="token punctuation">,</span> pJsArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>        String msg<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>TextUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>appId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            msg <span class="token operator">=</span> StringUtil<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"{code:%d,message:'%s'}"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">,</span> DOMException<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">"业务参数配置缺失"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            JSUtil<span class="token punctuation">.</span><span class="token function">execCallback</span><span class="token punctuation">(</span>pwebview<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mAuthCallbackId<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> JSUtil<span class="token punctuation">.</span>ERROR<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>PlatformUtil<span class="token punctuation">.</span><span class="token function">isAppInstalled</span><span class="token punctuation">(</span>pwebview<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"com.tencent.wework"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            msg <span class="token operator">=</span> StringUtil<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"{code:%d,message:'%s'}"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">,</span> DOMException<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">"客户端未安装"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            JSUtil<span class="token punctuation">.</span><span class="token function">execCallback</span><span class="token punctuation">(</span>pwebview<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mAuthCallbackId<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> JSUtil<span class="token punctuation">.</span>ERROR<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            ThreadPool<span class="token punctuation">.</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addThreadTask</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    QyWeiXinOAuthService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>isAuth <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                    QyWeiXinOAuthService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loginInThread</span><span class="token punctuation">(</span>QyWeiXinOAuthService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mAuthWebview<span class="token punctuation">,</span> QyWeiXinOAuthService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mAuthCallbackId<span class="token punctuation">,</span> QyWeiXinOAuthService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mAuthOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">loginInThread</span><span class="token punctuation">(</span><span class="token keyword">final</span> IWebview pwebview<span class="token punctuation">,</span> <span class="token keyword">final</span> String callbackId<span class="token punctuation">,</span> JSONObject option<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>iwwapi <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//注册</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>iwwapi <span class="token operator">=</span> WWAPIFactory<span class="token punctuation">.</span><span class="token function">createWWAPI</span><span class="token punctuation">(</span>pwebview<span class="token punctuation">.</span><span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>iwwapi<span class="token punctuation">.</span><span class="token function">registerApp</span><span class="token punctuation">(</span>SCHEMA<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">final</span> WWAuthMessage<span class="token punctuation">.</span>Req req <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WWAuthMessage<span class="token punctuation">.</span>Req</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        req<span class="token punctuation">.</span>sch <span class="token operator">=</span> SCHEMA<span class="token punctuation">;</span>        req<span class="token punctuation">.</span>appId <span class="token operator">=</span> appId<span class="token punctuation">;</span>        req<span class="token punctuation">.</span>agentId <span class="token operator">=</span> agentId<span class="token punctuation">;</span>        req<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">"combest"</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//授权成功之后的回调函数</span>        iwwapi<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">IWWAPIEventHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleResp</span><span class="token punctuation">(</span>BaseMessage resp<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>resp <span class="token keyword">instanceof</span> <span class="token class-name">WWAuthMessage<span class="token punctuation">.</span>Resp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    WWAuthMessage<span class="token punctuation">.</span>Resp rsp <span class="token operator">=</span> <span class="token punctuation">(</span>WWAuthMessage<span class="token punctuation">.</span>Resp<span class="token punctuation">)</span> resp<span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>rsp<span class="token punctuation">.</span>errCode <span class="token operator">==</span> WWAuthMessage<span class="token punctuation">.</span>ERR_CANCEL<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>pwebview<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"登陆取消"</span><span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rsp<span class="token punctuation">.</span>errCode <span class="token operator">==</span> WWAuthMessage<span class="token punctuation">.</span>ERR_FAIL<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>pwebview<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"登陆失败"</span><span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rsp<span class="token punctuation">.</span>errCode <span class="token operator">==</span> WWAuthMessage<span class="token punctuation">.</span>ERR_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>pwebview<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"登陆成功"</span><span class="token punctuation">,</span>                                Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        QyWeiXinOAuthService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> rsp<span class="token punctuation">.</span>code<span class="token punctuation">;</span>                        JSUtil<span class="token punctuation">.</span><span class="token function">execCallback</span><span class="token punctuation">(</span>pwebview<span class="token punctuation">,</span> callbackId<span class="token punctuation">,</span> QyWeiXinOAuthService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">makeResultJSONObject</span><span class="token punctuation">(</span>rsp<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">,</span> JSUtil<span class="token punctuation">.</span>OK<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onLoginFinished</span><span class="token punctuation">(</span>JSONObject msg<span class="token punctuation">,</span> <span class="token keyword">boolean</span> suc<span class="token punctuation">,</span> IWebview pwebview<span class="token punctuation">,</span> String callbackId<span class="token punctuation">)</span> <span class="token punctuation">{</span>        JSUtil<span class="token punctuation">.</span><span class="token function">execCallback</span><span class="token punctuation">(</span>pwebview<span class="token punctuation">,</span> callbackId<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> suc <span class="token operator">?</span> JSUtil<span class="token punctuation">.</span>OK <span class="token operator">:</span> JSUtil<span class="token punctuation">.</span>ERROR<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>isAuth<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>mAuthWebview <span class="token operator">=</span> null<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>mAuthCallbackId <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>mLoginCallbackId <span class="token operator">=</span> null<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>mLoginWebViewImpl <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">logout</span><span class="token punctuation">(</span>IWebview pWebViewImpl<span class="token punctuation">,</span> JSONArray pJsArgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span>pWebViewImpl<span class="token punctuation">,</span> pJsArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hasGeneralError</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mLogoutWebViewImpl<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mLogoutCallbackId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">removeToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>userInfo <span class="token operator">=</span> null<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>authResult <span class="token operator">=</span> null<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onLogoutFinished</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">makeResultJSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>iwwapi <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> JSONObject <span class="token function">makeResultJSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        JSONObject sucJSON <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            sucJSON<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"authResult"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authResult<span class="token punctuation">)</span><span class="token punctuation">;</span>            String state <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">"state"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            sucJSON<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"state"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>            sucJSON<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JSONException</span> var3<span class="token punctuation">)</span> <span class="token punctuation">{</span>            var3<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> sucJSON<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> JSONObject <span class="token function">makeResultJSONObject</span><span class="token punctuation">(</span>String code<span class="token punctuation">)</span> <span class="token punctuation">{</span>        JSONObject sucJSON <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            String state <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">"state"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            sucJSON<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"state"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>            sucJSON<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"authResult"</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JSONException</span> var3<span class="token punctuation">)</span> <span class="token punctuation">{</span>            var3<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> sucJSON<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></li></ul></li></ol><ul><li><p>在dcloud_properties.xml文件中，搜索OAuth，在name=”OAuth”的<code>&lt;feature&gt;</code>中添加一行<code>&lt;module&gt;</code></p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>feature</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>OAuth<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>io.dcloud.feature.oauth.OAuthFeatureImpl<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>OAuth-Weixin<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>io.dcloud.feature.oauth.weixin.WeiXinOAuthService<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>OAuth-QQ<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>io.dcloud.feature.oauth.qq.QQOAuthService<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>OAuth-Sina<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>io.dcloud.feature.oauth.sina.SinaOAuthService<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>OAuth-Qihoo<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>io.dcloud.oauth.qihoo.QihooOAuthService<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>OAuth-MiUi<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>io.dcloud.feature.oauth.miui.MiUiOAuthService<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>OAuth-QyWeixin<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>io.dcloud.HelloH5.wxapi.QyWeiXinOAuthService<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>feature</span><span class="token punctuation">></span></span></code></pre></li><li><p>在AndroidManifest.xml文件中，添加企业微信appid和agentid的定义</p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta-data</span>            <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>QYWX_APPID<span class="token punctuation">"</span></span>            <span class="token attr-name"><span class="token namespace">android:</span>value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ww**********cfae<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta-data</span>           <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>QYWX_AGENTID<span class="token punctuation">"</span></span>           <span class="token attr-name"><span class="token namespace">android:</span>value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1000006<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></code></pre></li></ul><h3 id="五、关键！webAPP与Android之间的通信，传递参数"><a href="#五、关键！webAPP与Android之间的通信，传递参数" class="headerlink" title="五、关键！webAPP与Android之间的通信，传递参数"></a>五、<span style="color:red">关键！</span>webAPP与Android之间的通信，传递参数</h3><ol><li><h4 id="webAPP端"><a href="#webAPP端" class="headerlink" title="webAPP端"></a>webAPP端</h4><p>接口说明链接：<a href="http://www.html5plus.org/doc/zh_cn/oauth.html#plus.oauth.getServices">OAuth模块</a></p><p>如果你也是和我一样用Vue开发的APP，可以这样写</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">let</span> instance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>plus<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>    plus<span class="token punctuation">.</span>oauth<span class="token punctuation">.</span><span class="token function">getServices</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>services<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">var</span> qyweixin<span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token keyword">in</span> services<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">var</span> service<span class="token operator">=</span>services<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span>id <span class="token operator">==</span> <span class="token string">"qyweixin"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                qyweixin <span class="token operator">=</span> service<span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>qyweixin<span class="token punctuation">)</span><span class="token punctuation">{</span>        qyweixin<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// Toast(JSON.stringify(qyweixin.authResult));</span>            instance<span class="token punctuation">.</span><span class="token function">getUserInfo</span><span class="token punctuation">(</span>qyweixin<span class="token punctuation">.</span>authResult<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//根据code和access_token获取用户信息</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>            plus<span class="token punctuation">.</span>nativeUI<span class="token punctuation">.</span><span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"详情错误信息请参考授权登录(OAuth)规范文档：http://www.html5plus.org/#specification#/specification/OAuth.html"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token string">"登录失败["</span><span class="token operator">+</span>e<span class="token punctuation">.</span>code<span class="token operator">+</span><span class="token string">"]："</span><span class="token operator">+</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">Toast</span><span class="token punctuation">(</span><span class="token string">'获取登录认证失败：'</span><span class="token operator">+</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><h4 id="Android端"><a href="#Android端" class="headerlink" title="Android端"></a>Android端</h4><p><strong>同步执行方法：</strong>JSUtil.wrapJsVar(“Html5 Plus Plugin Hello1!”,true);</p><blockquote><p><code>String wrapJsVar(String value, boolean isString);</code></p><p>转换JS层的返回值，也用于异步接口中回调函数的参数。</p><p><strong>参数说明：</strong><br><strong>value：</strong> 要返回到JS层的值<br><strong>isString：</strong>返回值类型是否为原始字符串<br><strong>返回方法：</strong><br><strong>boolea类型：</strong> wrapJSVar( “true”, false );<br><strong>Number类型：</strong> wrapJsVar( “99”, false );<br><strong>String类型：</strong> wrapJsVar( “hello”, true );<br><strong>数组类型：</strong> wrapJsVar( “[1,2,3,4,5]”, false );<br><strong>JSON类型：</strong> wrapJsVar( “{‘name’:’value’}”, false );</p></blockquote><p><strong>异步执行方法：</strong>JSUtil.execCallback(pWebview , pCallbackId, msg, JSUtil.ERROR, true, false);</p><blockquote><p><code>String execCallback(IWebview pWebView, String pCallbackId, String pMessage, int pStatus, boolean isJson, boolean pKeepCallback);</code></p><p>触发扩展插件中的回调方法。</p><p><strong>参数说明：</strong><br><strong>pWebView：</strong>扩展插件方法运行的窗口<br><strong>pCallbackId：</strong>回调函数的唯一标识<br><strong>pMessage：</strong>回调函数的参数<br><strong>pStatus：</strong>操作是否成功，成功则使用JSUtil.OK，否则使用错误代码<br><strong>isJson：</strong>回调函数参数是否为JSON数据<br><strong>pKeepCallback：</strong>是否可多次触发回调函数</p></blockquote></li><li><h4 id="后端"><a href="#后端" class="headerlink" title="后端"></a>后端</h4><p>根据得到的code获取企业微信的userInfo，这里用到了<a href="https://gitee.com/binary/weixin-java-tools">WxJava</a>，具体整合方法这里就不再过多的叙述了，具体可以查看文档<a href="https://github.com/Wechat-Group/WxJava/wiki/%E4%BC%81%E4%B8%9A%E5%8F%B7%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3">企业号开发文档</a>，java代码如下：</p><pre class=" language-java"><code class="language-java">String accessToken <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>WxCpDefaultConfigImpl config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WxCpDefaultConfigImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>config<span class="token punctuation">.</span><span class="token function">setCorpId</span><span class="token punctuation">(</span><span class="token string">"ww*********fae"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 设置微信企业号的appid</span>config<span class="token punctuation">.</span><span class="token function">setCorpSecret</span><span class="token punctuation">(</span><span class="token string">"lv**********************fu1S02c0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 设置微信企业号的app corpSecret</span>config<span class="token punctuation">.</span><span class="token function">setAgentId</span><span class="token punctuation">(</span><span class="token number">1000006</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// 设置微信企业号应用ID</span>WxCpServiceImpl wxCpService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WxCpServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>wxCpService<span class="token punctuation">.</span><span class="token function">setWxCpConfigStorage</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>accessToken <span class="token operator">=</span> wxCpService<span class="token punctuation">.</span><span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>WxCpOauth2UserInfo res <span class="token operator">=</span>  wxCpService<span class="token punctuation">.</span><span class="token function">getOauth2Service</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUserInfo</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//根据userId获取详细信息</span>WxCpUser weChatUser <span class="token operator">=</span> wxCpService<span class="token punctuation">.</span><span class="token function">getUserService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li></ol><h3 id="六、在企业微信企业管理后台中进行配置"><a href="#六、在企业微信企业管理后台中进行配置" class="headerlink" title="六、在企业微信企业管理后台中进行配置"></a>六、在企业微信企业管理后台中进行配置</h3><ol><li><p>在自建应用中，启用企业微信授权登录</p><p><img src="https://i.loli.net/2021/01/22/ErJeIFib5ORQa7L.png"> </p></li><li><p>还记得我们在第一步，手机端下载的生成签名的APP吗，这里就需要用到它了，在HBuilder-Hello项目的AndroidManifest.xml文件中可以查看到当前项目的包名</p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifest</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>    <span class="token attr-name"><span class="token namespace">xmlns:</span>tools</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/tools<span class="token punctuation">"</span></span>    <span class="token attr-name">package</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>io.dcloud.HelloH5<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></code></pre></li><li><p>在APP中输入包名，得到签名回填到企业微信管理后台</p><p><img src="https://i.loli.net/2021/01/22/AC34EVwWPgMl6bp.png"> </p><hr><p>至此，整个过程就完美结束啦~​ <span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f4ae.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f4ae.png?v8">💮</span></p></li></ol><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> 技术文档 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> WebApp </tag>
            
            <tag> 企业微信 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>毕业季</title>
      <link href="2020/10/01/bi-ye-ji/"/>
      <url>2020/10/01/bi-ye-ji/</url>
      
        <content type="html"><![CDATA[<h3 id="emsp-在广袤的空间和无限的时间中-能与你们共享一颗行星和同一段时光-是我的荣幸"><a href="#emsp-在广袤的空间和无限的时间中-能与你们共享一颗行星和同一段时光-是我的荣幸" class="headerlink" title=" 在广袤的空间和无限的时间中,能与你们共享一颗行星和同一段时光,是我的荣幸"></a><strong><font color="#996699"> 在广袤的空间和无限的时间中,能与你们共享一颗行星和同一段时光,是我的荣幸</font></strong></h3><hr><p><img src="https://raw.githubusercontent.com/Zoracxz/Random-img/master/house.jpg" alt="love &amp; peace"></p><h2 id="我们想说的话"><a href="#我们想说的话" class="headerlink" title="我们想说的话"></a>我们想说的话</h2><p>黄🐕：</p><blockquote><p>我总是说要去娟（我的锤子）家里，去吃她家的鸽子（虽然她不让我吃，但谁又care呢）去看她家的梯田去下一受感‬‬在这样一个热情烈热‬‬的家庭里有多么的心舒‬‬幸福。是可‬‬都毕业了我是还‬‬没去成。</p></blockquote><hr><blockquote><p>总是应答‬‬丽珍（我的犬儿子）要和她去日本去长白山去西宁‬‬去遍有所‬‬地方玩，要带她来北海吃粉（但是不许她住家我‬‬让她去流浪）带她去涠洲岛玩。可是到后最‬‬毕业了我还是骗了她哈哈哈‬‬哈哈哈。</p></blockquote><hr><blockquote><p>是总‬‬说要在猪哥（我的麻批）还在日本书读‬‬的时候去日本和丽珍起一‬‬找他玩，住她的宿舍睡他的床占用她的时间陪我们玩（都是丽珍说的，珍丽‬‬赖皮天下无敌）。可是到猪哥回沙长‬‬了我还是没去成，又让丽珍狗子儿‬‬一个人去了哈哈哈哈哈哈哈。</p></blockquote><hr><blockquote><p> 憾遗‬‬这两天没有回去和她们一起度过最后这这‬‬打闹的时间，到想‬‬以后会不‬‬再听到珍丽‬‬独特的大嗓门，姨妈痛时地喊天哭‬‬的声音委屈的说我们不关心她哈哈哈，再会不‬‬有人深更半夜掀我帘床‬‬了，再也不能跑到丽珍上床‬‬揍她了，再也不能深更半夜在亚娟的床底下桌子用上‬‬她的电脑写作业，再也不能跟亚娟一起去出‬‬逛理工北门了，再也不能调侃亚娟那些哥哥们了，再也不能看到亚娟整天徘徊在我的衣服包包‬‬旁边那暗示的眼神，如果能来重‬‬一次我一定会告诉你！&nbsp;休想碰！能不也再‬‬让猪哥介绍本日‬‬小哥哥给我（其实是亚娟）认识了，再也不能让哥猪‬‬给我考试前临时脚佛抱‬‬了，再也不能吃到猪哥从家里带来的辣条和酱板鸭了，再也不能到吃‬‬猪哥做的辣椒炒肉（我的最爱）了！！！！<br> 离开了她们我的真‬‬好伤心，后以‬‬路上再也没有人给我搭膀肩‬‬了（虽然我都小开‬‬电驴），我再也不能在宿舍二挑一‬‬把猪和狗干趴下了哈哈哈哈哈哈（思意小‬‬小意思，不用夸我），再也不能在床上使唤们他‬‬帮我拿东西了（上床‬‬生根了没办法），能不也再‬‬在亚娟电脑上我的专属文件夹里加增‬‬属于我的东西了（在亚娟的电脑里我的专属夹件文‬‬大概也就占半一‬‬内存吧哈哈‬‬哈哈哈<br><br><br><br><img src="https://github.com/Zoracxz/Random-img/raw/master/line.png" alt="我是分割线"></p></blockquote><p>娟：</p><blockquote><p><strong><font color="#FF9966">在夏天遇见的就在夏天告别吧</font></strong></p><blockquote><p><a href="https://mp.weixin.qq.com/s/kkCKPbjUSPDm0gHAGDeJGQ"><font color="#99CC99">この夏</font></a></p></blockquote></blockquote><p><img src="https://github.com/Zoracxz/Random-img/raw/master/start.jpg" alt="银河"><br>我很庆幸在最美好的时间里遇到你们，希望我们未来都越来越好。</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
