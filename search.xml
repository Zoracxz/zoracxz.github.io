<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Android平台整合H5WebApp，集成企业微信SDK</title>
      <link href="2021/01/22/android-ping-tai-zheng-he-h5webapp-ji-cheng-qi-ye-wei-xin-sdk/"/>
      <url>2021/01/22/android-ping-tai-zheng-he-h5webapp-ji-cheng-qi-ye-wei-xin-sdk/</url>
      
        <content type="html"><![CDATA[<h1 id="Android平台整合H5WebApp，集成企业微信SDK"><a href="#Android平台整合H5WebApp，集成企业微信SDK" class="headerlink" title="Android平台整合H5WebApp，集成企业微信SDK"></a>Android平台整合H5WebApp，集成企业微信SDK</h1><h3 id="一、整合前准备"><a href="#一、整合前准备" class="headerlink" title="一、整合前准备"></a>一、整合前准备</h3><ol><li><p>下载<a href="https://nativesupport.dcloud.net.cn/AppDocs/download/android">AndroidSDK</a></p></li><li><p><a href="https://work.weixin.qq.com/api/doc/90000/90138/91074">企业微信移动端SDK</a>资源下载，将签名生成工具安装在手机端，之后在获取企业微信登录权限时需要用到。</p><blockquote><p>使用企业微信登录、分享功能需要用到文件如下。<br>点击下载<a href="http://open.work.weixin.qq.com/wwopen/downloadfile/wwapi.zip">Android开发工具包集合</a> 。每个第三方应用必须要导入该SDK库，用于实现与企业微信的通信<br>点击下载 <a href="http://dldir1.qq.com/qqcontacts/Gen_Signature_Android.apk">签名生成工具</a>。安装此工具，根据指引生成的应用签名字符串并填写在应用管理平台上，未填写或者填写错误将导致接口无法使用。<br>点击下载<a href="http://dldir1.qq.com/qqcontacts/apitest_2.zip">接口使用Demo</a>。开发者可以参考Demo中的接口使用方式进行开发。</p></blockquote></li><li><p>必要开发软件自行下载</p><ul><li>Android studio</li><li>Hbuilder</li></ul></li></ol><h3 id="二、导入AndroidDemo"><a href="#二、导入AndroidDemo" class="headerlink" title="二、导入AndroidDemo"></a>二、导入AndroidDemo</h3><ol><li><p>sdk目录         </p><p><img src="https://i.loli.net/2021/01/22/9bTciu8DAyv1kNS.png"> </p></li><li><p>将HBuilder-Hello导入Android Studio，在导入过程中可能会出现各种奇奇怪怪的问题，请自行百度解决，在这里提供一些可能会出现问题的解决方法</p><ul><li><p><strong>Error:Connection timed out: connect. If you are behind an HTTP proxy, please configure the proxy settings either in IDE or Gradle.</strong></p><p>由于网络原因，无法下载gradle，解决办法：</p><p>在项目目录，“<em>\gradle\wrapper\gradle-wrapper.properties</em>”中查看当前项目所需要的gradle版本号，如下所示：gradle的版本为gradle-6.5-all.zip</p><p><code>distributionUrl=https\://services.gradle.org/distributions/gradle-6.5-all.zip</code></p><p>在<a href="https://www.androiddevtools.cn/">androiddevtools</a>中下载对应的gradle包，下载好之后直接丢进”<em>C:\Users\zora\.gradle\wrapper\dists\gradle-6.5-all\&lt;随机生成的字符串&gt;</em>“里面，重新运行Android Studio</p></li><li><p><strong>Error:Cause: failed to find target with hash string ‘android-23’</strong></p><p>缺少对应的SDK文件，解决方法：在Android Studio中打开”File&gt;Settings“,搜索sdk，下载对应的sdk文件，重新rebuild项目。</p></li></ul></li></ol><h3 id="三、整合webApp"><a href="#三、整合webApp" class="headerlink" title="三、整合webApp"></a>三、整合webApp</h3><p>官方离线打包参考链接：<a href="https://nativesupport.dcloud.net.cn/AppDocs/usesdk/android">Android离线打包</a></p><ol><li><p>​    打包H5+APP</p><p>在HBuilder中，打包成本地资源，将资源文件放在HBuilder-Hello的”<em>\app\src\main\assets\apps&lt;webApp对应id，在manifest.json中查看&gt;\www</em>“中，如果没有该文件夹则创建一个www空文件夹。</p><p><img src="https://i.loli.net/2021/01/22/YTknLBd324DbVgN.png">  <img src="https://i.loli.net/2021/01/22/sxlPiqzvEt2OR1d.png"></p></li><li><p>修改dcloud_control.xml中的appid，appid就是在manifest.json文件中定义的id，<strong>与apps下的文件夹同名</strong>。</p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hbuilder</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>apps</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>app</span> <span class="token attr-name">appid</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>H******E<span class="token punctuation">"</span></span> <span class="token attr-name">appver</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>apps</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>hbuilder</span><span class="token punctuation">></span></span></code></pre></li><li><p>运行项目</p><p><img src="https://i.loli.net/2021/01/22/GdxfWMEgAlmUY6j.png"> </p></li></ol><h3 id="四、整合企业微信SDK"><a href="#四、整合企业微信SDK" class="headerlink" title="四、整合企业微信SDK"></a>四、整合企业微信SDK</h3><p>官方sdk整合链接：<a href="https://work.weixin.qq.com/api/doc/90000/90136/91194">Android接入指南</a></p><ol><li><p>在下载好的企业微信Demo中，将”<em>\apitest_2\apitest\app\libs</em>“中的libwwsdk.jar复制到HBuilder-Hello的libs文件夹中，这样就成功的引入了企业微信sdk</p></li><li><p>进行代码开发，官方给出的代码对与纯Android原生开发的应用是没有问题的！但是，我们是整合了webAPP进行的混合开发！<span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f622.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f622.png?v8">😢</span></p><p>这里我找遍全网都没找到解决方法，可能是企业微信集成的需求不大？踩了很多坑，在看了一天的源码之后，摸索出一条解决办法，因为AndroidSDK中是提供了微信、qq等第三方登录接口的，所以我依葫芦画瓢，增加了一个企业微信的登录接口。可以参考<a href="https://ask.dcloud.net.cn/article/66">Android平台第三方插件开发指导</a></p><ul><li><p>在”<em>java\io\dcloud\HelloH5\wxapi</em>“中新建类<strong>QyWeiXinOAuthService.java</strong>继承<strong>BaseOAuthService</strong>，具体代码如下</p><pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> io<span class="token punctuation">.</span>dcloud<span class="token punctuation">.</span>HelloH5<span class="token punctuation">.</span>wxapi<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>Context<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>text<span class="token punctuation">.</span>TextUtils<span class="token punctuation">;</span><span class="token keyword">import</span> android<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>Toast<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>wework<span class="token punctuation">.</span>api<span class="token punctuation">.</span>IWWAPI<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>wework<span class="token punctuation">.</span>api<span class="token punctuation">.</span>IWWAPIEventHandler<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>wework<span class="token punctuation">.</span>api<span class="token punctuation">.</span>WWAPIFactory<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>wework<span class="token punctuation">.</span>api<span class="token punctuation">.</span>model<span class="token punctuation">.</span>BaseMessage<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>wework<span class="token punctuation">.</span>api<span class="token punctuation">.</span>model<span class="token punctuation">.</span>WWAuthMessage<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>json<span class="token punctuation">.</span>JSONArray<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>json<span class="token punctuation">.</span>JSONException<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>json<span class="token punctuation">.</span>JSONObject<span class="token punctuation">;</span><span class="token keyword">import</span> io<span class="token punctuation">.</span>dcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>DHInterface<span class="token punctuation">.</span>IWebview<span class="token punctuation">;</span><span class="token keyword">import</span> io<span class="token punctuation">.</span>dcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>adapter<span class="token punctuation">.</span>util<span class="token punctuation">.</span>AndroidResources<span class="token punctuation">;</span><span class="token keyword">import</span> io<span class="token punctuation">.</span>dcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>adapter<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Logger<span class="token punctuation">;</span><span class="token keyword">import</span> io<span class="token punctuation">.</span>dcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>adapter<span class="token punctuation">.</span>util<span class="token punctuation">.</span>PlatformUtil<span class="token punctuation">;</span><span class="token keyword">import</span> io<span class="token punctuation">.</span>dcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>constant<span class="token punctuation">.</span>DOMException<span class="token punctuation">;</span><span class="token keyword">import</span> io<span class="token punctuation">.</span>dcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>util<span class="token punctuation">.</span>JSUtil<span class="token punctuation">;</span><span class="token keyword">import</span> io<span class="token punctuation">.</span>dcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>util<span class="token punctuation">.</span>StringUtil<span class="token punctuation">;</span><span class="token keyword">import</span> io<span class="token punctuation">.</span>dcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>util<span class="token punctuation">.</span>ThreadPool<span class="token punctuation">;</span><span class="token keyword">import</span> io<span class="token punctuation">.</span>dcloud<span class="token punctuation">.</span>feature<span class="token punctuation">.</span>oauth<span class="token punctuation">.</span>BaseOAuthService<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QyWeiXinOAuthService</span> <span class="token keyword">extends</span> <span class="token class-name">BaseOAuthService</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> IWWAPI iwwapi<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//企业微信api</span>    <span class="token keyword">private</span> String code<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String TAG <span class="token operator">=</span> <span class="token string">"QyWeiXinOAuthService"</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String SCHEMA <span class="token operator">=</span> <span class="token string">"wwauth***********000006"</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//企业微信授权登录中的SCHEMA，获取方法请参考步骤六</span>    <span class="token keyword">protected</span> <span class="token keyword">static</span> String appId <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token keyword">protected</span> <span class="token keyword">static</span> String agentId <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> isAuth <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">QyWeiXinOAuthService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasFullConfigData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token operator">!</span>TextUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>appId<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initAuthOptions</span><span class="token punctuation">(</span>JSONObject mLoginOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mLoginOptions <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            appId <span class="token operator">=</span> mLoginOptions<span class="token punctuation">.</span><span class="token function">optString</span><span class="token punctuation">(</span><span class="token string">"appid"</span><span class="token punctuation">,</span> appId<span class="token punctuation">)</span><span class="token punctuation">;</span>            Logger<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"QyWeiXinOAuthService"</span><span class="token punctuation">,</span> <span class="token string">"initAuthOptions: appId"</span> <span class="token operator">+</span> appId<span class="token punctuation">)</span><span class="token punctuation">;</span>            agentId <span class="token operator">=</span> mLoginOptions<span class="token punctuation">.</span><span class="token function">optString</span><span class="token punctuation">(</span><span class="token string">"agentId"</span><span class="token punctuation">,</span> agentId<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initMetaData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        appId <span class="token operator">=</span> AndroidResources<span class="token punctuation">.</span><span class="token function">getMetaValue</span><span class="token punctuation">(</span><span class="token string">"QYWX_APPID"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        agentId <span class="token operator">=</span> AndroidResources<span class="token punctuation">.</span><span class="token function">getMetaValue</span><span class="token punctuation">(</span><span class="token string">"QYWX_AGENTID"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token string">"qyweixin"</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>description <span class="token operator">=</span> <span class="token string">"企业微信"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">onLoginCallBack</span><span class="token punctuation">(</span>IWebview pWebViewImpl<span class="token punctuation">,</span> String pCallbackId<span class="token punctuation">,</span> <span class="token keyword">int</span> code<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">boolean</span> suc <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        String errorMsg <span class="token operator">=</span> <span class="token string">"send"</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">==</span> WWAuthMessage<span class="token punctuation">.</span>ERR_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>            suc <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">==</span> WWAuthMessage<span class="token punctuation">.</span>ERR_FAIL<span class="token punctuation">)</span> <span class="token punctuation">{</span>            errorMsg <span class="token operator">=</span> <span class="token string">"登录失败"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">==</span> WWAuthMessage<span class="token punctuation">.</span>ERR_CANCEL<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onLoginFinished</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getErrorJsonbject</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"用户取消"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> pWebViewImpl<span class="token punctuation">,</span> pCallbackId<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>suc<span class="token punctuation">)</span> <span class="token punctuation">{</span>            JSUtil<span class="token punctuation">.</span><span class="token function">execCallback</span><span class="token punctuation">(</span>pWebViewImpl<span class="token punctuation">,</span> pCallbackId<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">makeResultJSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> JSUtil<span class="token punctuation">.</span>OK<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            String msg <span class="token operator">=</span> DOMException<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">100</span><span class="token punctuation">,</span> errorMsg<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>            JSUtil<span class="token punctuation">.</span><span class="token function">execCallback</span><span class="token punctuation">(</span>pWebViewImpl<span class="token punctuation">,</span> pCallbackId<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> JSUtil<span class="token punctuation">.</span>ERROR<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">login</span><span class="token punctuation">(</span>IWebview pWebViewImpl<span class="token punctuation">,</span> JSONArray pJsArgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>pWebViewImpl<span class="token punctuation">,</span> pJsArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hasGeneralError</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mLoginWebViewImpl<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mLoginCallbackId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>PlatformUtil<span class="token punctuation">.</span><span class="token function">isAppInstalled</span><span class="token punctuation">(</span>pWebViewImpl<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"com.tencent.wework"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                String msg <span class="token operator">=</span> StringUtil<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"{code:%d,message:'%s'}"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">,</span> DOMException<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">"客户端未安装"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                JSUtil<span class="token punctuation">.</span><span class="token function">execCallback</span><span class="token punctuation">(</span>pWebViewImpl<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mLoginCallbackId<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> JSUtil<span class="token punctuation">.</span>ERROR<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                ThreadPool<span class="token punctuation">.</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addThreadTask</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        QyWeiXinOAuthService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loginInThread</span><span class="token punctuation">(</span>QyWeiXinOAuthService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mLoginWebViewImpl<span class="token punctuation">,</span> QyWeiXinOAuthService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mLoginCallbackId<span class="token punctuation">,</span> QyWeiXinOAuthService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mLoginOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">authorize</span><span class="token punctuation">(</span>IWebview pwebview<span class="token punctuation">,</span> JSONArray pJsArgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">authorize</span><span class="token punctuation">(</span>pwebview<span class="token punctuation">,</span> pJsArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>        String msg<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>TextUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>appId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            msg <span class="token operator">=</span> StringUtil<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"{code:%d,message:'%s'}"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">,</span> DOMException<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">"业务参数配置缺失"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            JSUtil<span class="token punctuation">.</span><span class="token function">execCallback</span><span class="token punctuation">(</span>pwebview<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mAuthCallbackId<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> JSUtil<span class="token punctuation">.</span>ERROR<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>PlatformUtil<span class="token punctuation">.</span><span class="token function">isAppInstalled</span><span class="token punctuation">(</span>pwebview<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"com.tencent.wework"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            msg <span class="token operator">=</span> StringUtil<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"{code:%d,message:'%s'}"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">,</span> DOMException<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">"客户端未安装"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            JSUtil<span class="token punctuation">.</span><span class="token function">execCallback</span><span class="token punctuation">(</span>pwebview<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mAuthCallbackId<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> JSUtil<span class="token punctuation">.</span>ERROR<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            ThreadPool<span class="token punctuation">.</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addThreadTask</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    QyWeiXinOAuthService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>isAuth <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                    QyWeiXinOAuthService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loginInThread</span><span class="token punctuation">(</span>QyWeiXinOAuthService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mAuthWebview<span class="token punctuation">,</span> QyWeiXinOAuthService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mAuthCallbackId<span class="token punctuation">,</span> QyWeiXinOAuthService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mAuthOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">loginInThread</span><span class="token punctuation">(</span><span class="token keyword">final</span> IWebview pwebview<span class="token punctuation">,</span> <span class="token keyword">final</span> String callbackId<span class="token punctuation">,</span> JSONObject option<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>iwwapi <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//注册</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>iwwapi <span class="token operator">=</span> WWAPIFactory<span class="token punctuation">.</span><span class="token function">createWWAPI</span><span class="token punctuation">(</span>pwebview<span class="token punctuation">.</span><span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>iwwapi<span class="token punctuation">.</span><span class="token function">registerApp</span><span class="token punctuation">(</span>SCHEMA<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">final</span> WWAuthMessage<span class="token punctuation">.</span>Req req <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WWAuthMessage<span class="token punctuation">.</span>Req</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        req<span class="token punctuation">.</span>sch <span class="token operator">=</span> SCHEMA<span class="token punctuation">;</span>        req<span class="token punctuation">.</span>appId <span class="token operator">=</span> appId<span class="token punctuation">;</span>        req<span class="token punctuation">.</span>agentId <span class="token operator">=</span> agentId<span class="token punctuation">;</span>        req<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">"combest"</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//授权成功之后的回调函数</span>        iwwapi<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">IWWAPIEventHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleResp</span><span class="token punctuation">(</span>BaseMessage resp<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>resp <span class="token keyword">instanceof</span> <span class="token class-name">WWAuthMessage<span class="token punctuation">.</span>Resp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    WWAuthMessage<span class="token punctuation">.</span>Resp rsp <span class="token operator">=</span> <span class="token punctuation">(</span>WWAuthMessage<span class="token punctuation">.</span>Resp<span class="token punctuation">)</span> resp<span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>rsp<span class="token punctuation">.</span>errCode <span class="token operator">==</span> WWAuthMessage<span class="token punctuation">.</span>ERR_CANCEL<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>pwebview<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"登陆取消"</span><span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rsp<span class="token punctuation">.</span>errCode <span class="token operator">==</span> WWAuthMessage<span class="token punctuation">.</span>ERR_FAIL<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>pwebview<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"登陆失败"</span><span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rsp<span class="token punctuation">.</span>errCode <span class="token operator">==</span> WWAuthMessage<span class="token punctuation">.</span>ERR_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>pwebview<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"登陆成功"</span><span class="token punctuation">,</span>                                Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        QyWeiXinOAuthService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> rsp<span class="token punctuation">.</span>code<span class="token punctuation">;</span>                        JSUtil<span class="token punctuation">.</span><span class="token function">execCallback</span><span class="token punctuation">(</span>pwebview<span class="token punctuation">,</span> callbackId<span class="token punctuation">,</span> QyWeiXinOAuthService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">makeResultJSONObject</span><span class="token punctuation">(</span>rsp<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">,</span> JSUtil<span class="token punctuation">.</span>OK<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onLoginFinished</span><span class="token punctuation">(</span>JSONObject msg<span class="token punctuation">,</span> <span class="token keyword">boolean</span> suc<span class="token punctuation">,</span> IWebview pwebview<span class="token punctuation">,</span> String callbackId<span class="token punctuation">)</span> <span class="token punctuation">{</span>        JSUtil<span class="token punctuation">.</span><span class="token function">execCallback</span><span class="token punctuation">(</span>pwebview<span class="token punctuation">,</span> callbackId<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> suc <span class="token operator">?</span> JSUtil<span class="token punctuation">.</span>OK <span class="token operator">:</span> JSUtil<span class="token punctuation">.</span>ERROR<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>isAuth<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>mAuthWebview <span class="token operator">=</span> null<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>mAuthCallbackId <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>mLoginCallbackId <span class="token operator">=</span> null<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>mLoginWebViewImpl <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">logout</span><span class="token punctuation">(</span>IWebview pWebViewImpl<span class="token punctuation">,</span> JSONArray pJsArgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span>pWebViewImpl<span class="token punctuation">,</span> pJsArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hasGeneralError</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mLogoutWebViewImpl<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mLogoutCallbackId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">removeToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>userInfo <span class="token operator">=</span> null<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>authResult <span class="token operator">=</span> null<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onLogoutFinished</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">makeResultJSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>iwwapi <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> JSONObject <span class="token function">makeResultJSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        JSONObject sucJSON <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            sucJSON<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"authResult"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authResult<span class="token punctuation">)</span><span class="token punctuation">;</span>            String state <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">"state"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            sucJSON<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"state"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>            sucJSON<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JSONException</span> var3<span class="token punctuation">)</span> <span class="token punctuation">{</span>            var3<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> sucJSON<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> JSONObject <span class="token function">makeResultJSONObject</span><span class="token punctuation">(</span>String code<span class="token punctuation">)</span> <span class="token punctuation">{</span>        JSONObject sucJSON <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            String state <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">"state"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            sucJSON<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"state"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>            sucJSON<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"authResult"</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JSONException</span> var3<span class="token punctuation">)</span> <span class="token punctuation">{</span>            var3<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> sucJSON<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></li></ul></li></ol><ul><li><p>在dcloud_properties.xml文件中，搜索OAuth，在name=”OAuth”的<feature>中添加一行<module></module></feature></p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>feature</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>OAuth<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>io.dcloud.feature.oauth.OAuthFeatureImpl<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>OAuth-Weixin<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>io.dcloud.feature.oauth.weixin.WeiXinOAuthService<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>OAuth-QQ<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>io.dcloud.feature.oauth.qq.QQOAuthService<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>OAuth-Sina<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>io.dcloud.feature.oauth.sina.SinaOAuthService<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>OAuth-Qihoo<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>io.dcloud.oauth.qihoo.QihooOAuthService<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>OAuth-MiUi<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>io.dcloud.feature.oauth.miui.MiUiOAuthService<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>OAuth-QyWeixin<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>io.dcloud.HelloH5.wxapi.QyWeiXinOAuthService<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>feature</span><span class="token punctuation">></span></span></code></pre></li><li><p>在AndroidManifest.xml文件中，添加企业微信appid和agentid的定义</p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta-data</span>            <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>QYWX_APPID<span class="token punctuation">"</span></span>            <span class="token attr-name"><span class="token namespace">android:</span>value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ww**********cfae<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta-data</span>           <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>QYWX_AGENTID<span class="token punctuation">"</span></span>           <span class="token attr-name"><span class="token namespace">android:</span>value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1000006<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></code></pre></li></ul><h3 id="五、关键！webAPP与Android之间的通信，传递参数"><a href="#五、关键！webAPP与Android之间的通信，传递参数" class="headerlink" title="五、关键！webAPP与Android之间的通信，传递参数"></a>五、<span style="color:red">关键！</span>webAPP与Android之间的通信，传递参数</h3><ol><li><h4 id="webAPP端"><a href="#webAPP端" class="headerlink" title="webAPP端"></a>webAPP端</h4><p>接口说明链接：<a href="http://www.html5plus.org/doc/zh_cn/oauth.html#plus.oauth.getServices">OAuth模块</a></p><p>如果你也是和我一样用Vue开发的APP，可以这样写</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">let</span> instance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>plus<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>    plus<span class="token punctuation">.</span>oauth<span class="token punctuation">.</span><span class="token function">getServices</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>services<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">var</span> qyweixin<span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token keyword">in</span> services<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">var</span> service<span class="token operator">=</span>services<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span>id <span class="token operator">==</span> <span class="token string">"qyweixin"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                qyweixin <span class="token operator">=</span> service<span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>qyweixin<span class="token punctuation">)</span><span class="token punctuation">{</span>        qyweixin<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// Toast(JSON.stringify(qyweixin.authResult));</span>            instance<span class="token punctuation">.</span><span class="token function">getUserInfo</span><span class="token punctuation">(</span>qyweixin<span class="token punctuation">.</span>authResult<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//根据code和access_token获取用户信息</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>            plus<span class="token punctuation">.</span>nativeUI<span class="token punctuation">.</span><span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"详情错误信息请参考授权登录(OAuth)规范文档：http://www.html5plus.org/#specification#/specification/OAuth.html"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token string">"登录失败["</span><span class="token operator">+</span>e<span class="token punctuation">.</span>code<span class="token operator">+</span><span class="token string">"]："</span><span class="token operator">+</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">Toast</span><span class="token punctuation">(</span><span class="token string">'获取登录认证失败：'</span><span class="token operator">+</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><h4 id="Android端"><a href="#Android端" class="headerlink" title="Android端"></a>Android端</h4><p><strong>同步执行方法：</strong>JSUtil.wrapJsVar(“Html5 Plus Plugin Hello1!”,true);</p><blockquote><p><code>String wrapJsVar(String value, boolean isString);</code></p><p>转换JS层的返回值，也用于异步接口中回调函数的参数。</p><p><strong>参数说明：</strong><br><strong>value：</strong> 要返回到JS层的值<br><strong>isString：</strong>返回值类型是否为原始字符串<br><strong>返回方法：</strong><br><strong>boolea类型：</strong> wrapJSVar( “true”, false );<br><strong>Number类型：</strong> wrapJsVar( “99”, false );<br><strong>String类型：</strong> wrapJsVar( “hello”, true );<br><strong>数组类型：</strong> wrapJsVar( “[1,2,3,4,5]”, false );<br><strong>JSON类型：</strong> wrapJsVar( “{‘name’:’value’}”, false );</p></blockquote><p><strong>异步执行方法：</strong>JSUtil.execCallback(pWebview , pCallbackId, msg, JSUtil.ERROR, true, false);</p><blockquote><p><code>String execCallback(IWebview pWebView, String pCallbackId, String pMessage, int pStatus, boolean isJson, boolean pKeepCallback);</code></p><p>触发扩展插件中的回调方法。</p><p><strong>参数说明：</strong><br><strong>pWebView：</strong>扩展插件方法运行的窗口<br><strong>pCallbackId：</strong>回调函数的唯一标识<br><strong>pMessage：</strong>回调函数的参数<br><strong>pStatus：</strong>操作是否成功，成功则使用JSUtil.OK，否则使用错误代码<br><strong>isJson：</strong>回调函数参数是否为JSON数据<br><strong>pKeepCallback：</strong>是否可多次触发回调函数</p></blockquote></li><li><h4 id="后端"><a href="#后端" class="headerlink" title="后端"></a>后端</h4><p>根据得到的code获取企业微信的userInfo，这里用到了<a href="https://gitee.com/binary/weixin-java-tools">WxJava</a>，具体整合方法这里就不再过多的叙述了，具体可以查看文档<a href="https://github.com/Wechat-Group/WxJava/wiki/%E4%BC%81%E4%B8%9A%E5%8F%B7%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3">企业号开发文档</a>，java代码如下：</p><pre class=" language-java"><code class="language-java">String accessToken <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>WxCpDefaultConfigImpl config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WxCpDefaultConfigImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>config<span class="token punctuation">.</span><span class="token function">setCorpId</span><span class="token punctuation">(</span><span class="token string">"ww*********fae"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 设置微信企业号的appid</span>config<span class="token punctuation">.</span><span class="token function">setCorpSecret</span><span class="token punctuation">(</span><span class="token string">"lv**********************fu1S02c0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 设置微信企业号的app corpSecret</span>config<span class="token punctuation">.</span><span class="token function">setAgentId</span><span class="token punctuation">(</span><span class="token number">1000006</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// 设置微信企业号应用ID</span>WxCpServiceImpl wxCpService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WxCpServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>wxCpService<span class="token punctuation">.</span><span class="token function">setWxCpConfigStorage</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>accessToken <span class="token operator">=</span> wxCpService<span class="token punctuation">.</span><span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>WxCpOauth2UserInfo res <span class="token operator">=</span>  wxCpService<span class="token punctuation">.</span><span class="token function">getOauth2Service</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUserInfo</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//根据userId获取详细信息</span>WxCpUser weChatUser <span class="token operator">=</span> wxCpService<span class="token punctuation">.</span><span class="token function">getUserService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li></ol><h3 id="六、在企业微信企业管理后台中进行配置"><a href="#六、在企业微信企业管理后台中进行配置" class="headerlink" title="六、在企业微信企业管理后台中进行配置"></a>六、在企业微信企业管理后台中进行配置</h3><ol><li><p>在自建应用中，启用企业微信授权登录</p><p><img src="https://i.loli.net/2021/01/22/ErJeIFib5ORQa7L.png"> </p></li><li><p>还记得我们在第一步，手机端下载的生成签名的APP吗，这里就需要用到它了，在HBuilder-Hello项目的AndroidManifest.xml文件中可以查看到当前项目的包名</p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifest</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>    <span class="token attr-name"><span class="token namespace">xmlns:</span>tools</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://schemas.android.com/tools<span class="token punctuation">"</span></span>    <span class="token attr-name">package</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>io.dcloud.HelloH5<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></code></pre></li><li><p>在APP中输入包名，得到签名回填到企业微信管理后台</p><p><img src="https://i.loli.net/2021/01/22/AC34EVwWPgMl6bp.png"> </p><hr><p>至此，整个过程就完美结束啦~​ <span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f4ae.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f4ae.png?v8">💮</span></p></li></ol><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> 技术文档 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> WebApp </tag>
            
            <tag> 企业微信 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>毕业季</title>
      <link href="2020/10/01/bi-ye-ji/"/>
      <url>2020/10/01/bi-ye-ji/</url>
      
        <content type="html"><![CDATA[<h3 id="emsp-在广袤的空间和无限的时间中-能与你们共享一颗行星和同一段时光-是我的荣幸"><a href="#emsp-在广袤的空间和无限的时间中-能与你们共享一颗行星和同一段时光-是我的荣幸" class="headerlink" title=" 在广袤的空间和无限的时间中,能与你们共享一颗行星和同一段时光,是我的荣幸"></a><strong><font color="#996699"> 在广袤的空间和无限的时间中,能与你们共享一颗行星和同一段时光,是我的荣幸</font></strong></h3><hr><p><img src="https://raw.githubusercontent.com/Zoracxz/Random-img/master/house.jpg" alt="love &amp; peace"></p><h2 id="我们想说的话"><a href="#我们想说的话" class="headerlink" title="我们想说的话"></a>我们想说的话</h2><p>黄🐕：</p><blockquote><p>我总是说要去娟（我的锤子）家里，去吃她家的鸽子（虽然她不让我吃，但谁又care呢）去看她家的梯田去下一受感‬‬在这样一个热情烈热‬‬的家庭里有多么的心舒‬‬幸福。是可‬‬都毕业了我是还‬‬没去成。</p></blockquote><hr><blockquote><p>总是应答‬‬丽珍（我的犬儿子）要和她去日本去长白山去西宁‬‬去遍有所‬‬地方玩，要带她来北海吃粉（但是不许她住家我‬‬让她去流浪）带她去涠洲岛玩。可是到后最‬‬毕业了我还是骗了她哈哈哈‬‬哈哈哈。</p></blockquote><hr><blockquote><p>是总‬‬说要在猪哥（我的麻批）还在日本书读‬‬的时候去日本和丽珍起一‬‬找他玩，住她的宿舍睡他的床占用她的时间陪我们玩（都是丽珍说的，珍丽‬‬赖皮天下无敌）。可是到猪哥回沙长‬‬了我还是没去成，又让丽珍狗子儿‬‬一个人去了哈哈哈哈哈哈哈。</p></blockquote><hr><blockquote><p> 憾遗‬‬这两天没有回去和她们一起度过最后这这‬‬打闹的时间，到想‬‬以后会不‬‬再听到珍丽‬‬独特的大嗓门，姨妈痛时地喊天哭‬‬的声音委屈的说我们不关心她哈哈哈，再会不‬‬有人深更半夜掀我帘床‬‬了，再也不能跑到丽珍上床‬‬揍她了，再也不能深更半夜在亚娟的床底下桌子用上‬‬她的电脑写作业，再也不能跟亚娟一起去出‬‬逛理工北门了，再也不能调侃亚娟那些哥哥们了，再也不能看到亚娟整天徘徊在我的衣服包包‬‬旁边那暗示的眼神，如果能来重‬‬一次我一定会告诉你！&nbsp;休想碰！能不也再‬‬让猪哥介绍本日‬‬小哥哥给我（其实是亚娟）认识了，再也不能让哥猪‬‬给我考试前临时脚佛抱‬‬了，再也不能吃到猪哥从家里带来的辣条和酱板鸭了，再也不能到吃‬‬猪哥做的辣椒炒肉（我的最爱）了！！！！<br> 离开了她们我的真‬‬好伤心，后以‬‬路上再也没有人给我搭膀肩‬‬了（虽然我都小开‬‬电驴），我再也不能在宿舍二挑一‬‬把猪和狗干趴下了哈哈哈哈哈哈（思意小‬‬小意思，不用夸我），再也不能在床上使唤们他‬‬帮我拿东西了（上床‬‬生根了没办法），能不也再‬‬在亚娟电脑上我的专属文件夹里加增‬‬属于我的东西了（在亚娟的电脑里我的专属夹件文‬‬大概也就占半一‬‬内存吧哈哈‬‬哈哈哈<br><br><br><br><img src="https://github.com/Zoracxz/Random-img/raw/master/line.png" alt="我是分割线"></p></blockquote><p>娟：</p><blockquote><p><strong><font color="#FF9966">在夏天遇见的就在夏天告别吧</font></strong></p><blockquote><p><a href="https://mp.weixin.qq.com/s/kkCKPbjUSPDm0gHAGDeJGQ"><font color="#99CC99">この夏</font></a></p></blockquote></blockquote><p><img src="https://github.com/Zoracxz/Random-img/raw/master/start.jpg" alt="银河"><br>我很庆幸在最美好的时间里遇到你们，希望我们未来都越来越好。</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
        <tags>
            
            <tag> 不想为人知的小矫情 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
